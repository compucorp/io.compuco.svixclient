name: Tests

on: pull_request

jobs:
  run-unit-tests:

    runs-on: ubuntu-latest
    container:
      image: compucorp/php-fpm.civicrm:8.2
      options: --user root

    env:
      CIVICRM_EXTENSIONS_DIR: site/web/sites/all/modules/civicrm/tools/extensions
      CIVICRM_SETTINGS_DIR: site/web/sites/default

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
        ports:
          - 3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: Config mysql database as per CiviCRM requirement
        run: echo "SET GLOBAL sql_mode=(SELECT REPLACE(@@sql_mode,'ONLY_FULL_GROUP_BY',''));" | mysql -u root --password=root --host=mysql

      - name: Config amp
        run: amp config:set --mysql_dsn=mysql://root:root@mysql:3306

      - name: Build Drupal site
        run: /opt/buildkit/bin/civibuild create drupal-clean --civi-ver 6.4.1 --cms-ver 7.100 --web-root $GITHUB_WORKSPACE/site

      - uses: actions/checkout@v2
        with:
          path: ${{ env.CIVICRM_EXTENSIONS_DIR }}/io.compuco.svixclient

      - name: Install extension dependencies
        working-directory: ${{ env.CIVICRM_EXTENSIONS_DIR }}/io.compuco.svixclient
        run: composer install

      - name: Enable Svix Client extension
        working-directory: ${{ env.CIVICRM_EXTENSIONS_DIR }}
        run: cv en svixclient

      - name: Setup Test DB
        run: echo "CREATE DATABASE civicrm_test;" | mysql -u root --password=root --host=mysql

      - name: Update civicrm.settings.php
        run: |
          FILE_PATH="$GITHUB_WORKSPACE/site/web/sites/default/civicrm.settings.php"
          INSERT_LINE="\$GLOBALS['_CV']['TEST_DB_DSN'] = 'mysql://root:root@mysql:3306/civicrm_test?new_link=true';"
          TMP_FILE=$(mktemp)
          while IFS= read -r line
          do
              echo "$line" >> "$TMP_FILE"
              if [ "$line" = "<?php" ]; then
                  echo "$INSERT_LINE" >> "$TMP_FILE"
              fi
          done < "$FILE_PATH"
          mv "$TMP_FILE" "$FILE_PATH"
          echo "File modified successfully."

      - name: Run phpunit tests
        working-directory: ${{ env.CIVICRM_EXTENSIONS_DIR }}/io.compuco.svixclient
        run: phpunit9
